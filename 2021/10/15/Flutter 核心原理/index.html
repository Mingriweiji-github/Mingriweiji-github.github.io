<!DOCTYPE html>
<html lang="zh-CN">
    <!-- title -->


    

<!-- keywords -->



<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="author" content="KM">
    <meta name="renderer" content="webkit">
    <meta name="copyright" content="KM">
    
        <meta name="keywords" content="hexo,hexo-theme,hexo-blog">
    
    <meta name="description" content="">
    <meta name="description" content="Flutter  * 1.开发效率高- 快发阶段 JIT 即时编译，支持 HotReload，节省开发时间.发布节点 AOT提前编译生成高效机器码保证应用性能  * 2.高性能-基于 Skia 引擎提供高保证的 UI 体验  * 3.快速内存分配-Flutter 框架使用函数式流，这使得它在很大程度上依赖于底层的内存分配器。  * 4.类型安全和空安全-2.12 后开始支持空安全和静态类型检测，在">
<meta property="og:type" content="article">
<meta property="og:title" content="Flutter 核心原理">
<meta property="og:url" content="https://mingriweiji-github.github.io/2021/10/15/Flutter%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/index.html">
<meta property="og:site_name" content="KM的技术笔记">
<meta property="og:description" content="Flutter  * 1.开发效率高- 快发阶段 JIT 即时编译，支持 HotReload，节省开发时间.发布节点 AOT提前编译生成高效机器码保证应用性能  * 2.高性能-基于 Skia 引擎提供高保证的 UI 体验  * 3.快速内存分配-Flutter 框架使用函数式流，这使得它在很大程度上依赖于底层的内存分配器。  * 4.类型安全和空安全-2.12 后开始支持空安全和静态类型检测，在">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://pic.imgdb.cn/item/627cb9bb0947543129c1aafa.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/627d2c35094754312966eee5.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/627cbc1c0947543129c97cb8.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/627d0ee309475431290097c1.jpg">
<meta property="og:image" content="https://pic.imgdb.cn/item/627da9cb094754312944ea83.jpg">
<meta property="og:image" content="https://docs.flutter.dev/assets/images/docs/arch-overview/render-pipeline.png">
<meta property="og:image" content="https://docs.flutter.dev/assets/images/docs/arch-overview/trees.png">
<meta property="og:image" content="https://pic.imgdb.cn/item/627da96a0947543129441424.jpg">
<meta property="og:image" content="https://docs.flutter.dev/assets/images/docs/arch-overview/platform-channels.png">
<meta property="og:image" content="https://docs.flutter.dev/assets/images/docs/arch-overview/trees.png">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/e6c9d24ely1h1h4uc76gmj22e90u0n6q.jpg">
<meta property="og:image" content="http://img.cdn.guoshuyu.cn/20190604_Flutter-5/image3">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/e6c9d24ely1h1h4bsmck7j20u00v5ads.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/e6c9d24ely1h1h55cqqbej211y0g00uu.jpg">
<meta property="article:published_time" content="2021-10-15T02:15:10.000Z">
<meta property="article:modified_time" content="2022-05-13T12:27:20.051Z">
<meta property="article:author" content="KM">
<meta property="article:tag" content="Flutter">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pic.imgdb.cn/item/627cb9bb0947543129c1aafa.jpg">
    <meta http-equiv="Cache-control" content="no-cache">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <link rel="icon" href="/assets/favicon.ico">
    
    <title>Flutter 核心原理 · KM的博客</title>
    <!-- /*! loadCSS. [c]2017 Filament Group, Inc. MIT License */
/* This file is meant as a standalone workflow for
- testing support for link[rel=preload]
- enabling async CSS loading in browsers that do not support rel=preload
- applying rel preload css once loaded, whether supported or not.
*/ -->
<script>
    (function (w) {
        'use strict'
        // rel=preload support test
        if (!w.loadCSS) {
            w.loadCSS = function () {}
        }
        // define on the loadCSS obj
        var rp = (loadCSS.relpreload = {})
        // rel=preload feature support test
        // runs once and returns a function for compat purposes
        rp.support = (function () {
            var ret
            try {
                ret = w.document.createElement('link').relList.supports('preload')
            } catch (e) {
                ret = false
            }
            return function () {
                return ret
            }
        })()

        // if preload isn't supported, get an asynchronous load by using a non-matching media attribute
        // then change that media back to its intended value on load
        rp.bindMediaToggle = function (link) {
            // remember existing media attr for ultimate state, or default to 'all'
            var finalMedia = link.media || 'all'

            function enableStylesheet() {
                link.media = finalMedia
            }

            // bind load handlers to enable media
            if (link.addEventListener) {
                link.addEventListener('load', enableStylesheet)
            } else if (link.attachEvent) {
                link.attachEvent('onload', enableStylesheet)
            }

            // Set rel and non-applicable media type to start an async request
            // note: timeout allows this to happen async to let rendering continue in IE
            setTimeout(function () {
                link.rel = 'stylesheet'
                link.media = 'only x'
            })
            // also enable media after 3 seconds,
            // which will catch very old browsers (android 2.x, old firefox) that don't support onload on link
            setTimeout(enableStylesheet, 3000)
        }

        // loop through link elements in DOM
        rp.poly = function () {
            // double check this to prevent external calls from running
            if (rp.support()) {
                return
            }
            var links = w.document.getElementsByTagName('link')
            for (var i = 0; i < links.length; i++) {
                var link = links[i]
                // qualify links to those with rel=preload and as=style attrs
                if (
                    link.rel === 'preload' &&
                    link.getAttribute('as') === 'style' &&
                    !link.getAttribute('data-loadcss')
                ) {
                    // prevent rerunning on link
                    link.setAttribute('data-loadcss', true)
                    // bind listeners to toggle media back
                    rp.bindMediaToggle(link)
                }
            }
        }

        // if unsupported, run the polyfill
        if (!rp.support()) {
            // run once at least
            rp.poly()

            // rerun poly on an interval until onload
            var run = w.setInterval(rp.poly, 500)
            if (w.addEventListener) {
                w.addEventListener('load', function () {
                    rp.poly()
                    w.clearInterval(run)
                })
            } else if (w.attachEvent) {
                w.attachEvent('onload', function () {
                    rp.poly()
                    w.clearInterval(run)
                })
            }
        }

        // commonjs
        if (typeof exports !== 'undefined') {
            exports.loadCSS = loadCSS
        } else {
            w.loadCSS = loadCSS
        }
    })(typeof global !== 'undefined' ? global : this)
</script>

    <style type="text/css">
    @font-face {
        font-family: 'Oswald-Regular';
        src: url("/font/Oswald-Regular.ttf");
    }

    body {
        margin: 0;
    }

    header,
    footer,
    .back-top,
    .sidebar,
    .container,
    .site-intro-meta,
    .toc-wrapper {
        display: none;
    }

    .site-intro {
        position: relative;
        z-index: 3;
        width: 100%;
        /* height: 50vh; */
        overflow: hidden;
    }

    .site-intro-placeholder {
        position: absolute;
        z-index: -2;
        top: 0;
        left: 0;
        width: calc(100% + 300px);
        height: 100%;
        background: repeating-linear-gradient(-45deg, #444 0, #444 80px, #333 80px, #333 160px);
        background-position: center center;
        transform: translate3d(-226px, 0, 0);
        animation: gradient-move 2.5s ease-out 0s infinite;
    }

    @keyframes gradient-move {
        0% {
            transform: translate3d(-226px, 0, 0);
        }
        100% {
            transform: translate3d(0, 0, 0);
        }
    }
</style>

    <link rel="preload" href="/css/style.css?v=20211217" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="/css/dark.css?v=20211217" as="style">
    <link rel="stylesheet" href="/css/dark.css">
    <link rel="stylesheet" href="/css/mobile.css?v=20211217" media="(max-width: 960px)">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" as="script">
    <link rel="preload" href="/scripts/main.js?v=20211217" as="script">
    <link rel="preload" href="/scripts/dark.js?v=20211217" as="script">
    <link rel="preload" href="/font/Oswald-Regular.ttf" as="font" crossorigin>
    <link rel="preload" href="https://at.alicdn.com/t/font_327081_1dta1rlogw17zaor.woff" as="font" crossorigin>
    <!-- algolia -->
    
    <!-- 百度统计  -->
    
    <!-- 谷歌统计  -->
    
<link rel="alternate" href="/atom.xml" title="KM的技术笔记" type="application/atom+xml">
</head>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script type="text/javascript">
        if (typeof window.$ == undefined) {
            console.warn('jquery load from jsdelivr failed, will load local script')
            document.write('<script src="/lib/jquery.min.js" />')
        }
    </script>
    
        <body class="post-body">
    
        <!-- header -->
        <header class="header header-mobile">
    <!-- top read progress line -->
    <div class="header-element">
        <div class="read-progress"></div>
    </div>
    <!-- sidebar menu button -->
    <div class="header-element">
        
            <div class="header-sidebar-menu">
        
            
                <div style="padding-left: 1px;">&#xe775;</div>
            
        </div>
    </div>
    <!-- header actions -->
    <div class="header-actions">
        <!-- theme mode switch button -->
        <span class="header-theme-btn header-element">
            <i class="fas fa-adjust"></i>
        </span>
        <!-- back to home page text -->
        <span class="home-link header-element">
            <a href=/>KM的博客.</a>
        </span>
    </div>
    <!-- toggle banner for post layout -->
    
        
            <div class="banner">
        
            <div class="blog-title header-element">
                <a href="/">KM的博客.</a>
            </div>
            <div class="post-title header-element">
                <a href="#" class="post-name">Flutter 核心原理</a>
            </div>
        </div>
    
</header>

        <!-- fixed footer -->
        <footer class="footer-fixed">
    <!-- back to top button -->
    <div class="footer-fixed-element">
        
            <div class="back-top back-top-hidden">
        
        
            <div>&#xe639;</div>
        
        </div>
    </div>
</footer>

        <!-- wrapper -->
        <div class="wrapper">
            <div class="site-intro" style="







    height:50vh;

">
    
    <!-- 主页  -->
    
        
    <!-- 404页  -->
            
    <div class="site-intro-placeholder"></div>
    <div class="site-intro-img" style="background-image: url(/intro/post-bg.jpg)"></div>
    <div class="site-intro-meta">
        <!-- 标题  -->
        <h1 class="intro-title">
            <!-- 主页  -->
            
                Flutter 核心原理
            <!-- 404 -->
            
        </h1>
        <!-- 副标题 -->
        <p class="intro-subtitle">
            <!-- 主页副标题  -->
            
                
            <!-- 404 -->
            
        </p>
        <!-- 文章页 meta -->
        
            <div class="post-intros">
                <!-- 文章页标签  -->
                
                    <div class= post-intro-tags >
    
    
        <a class="post-tag" href="javascript:void(0);" data-tags="Flutter">Flutter</a>
    
</div>

                
                
                    <div class="post-intro-read">
                        <span>字数统计: <span class="post-count word-count">3.8k</span>阅读时长: <span class="post-count reading-time">14 min</span></span>
                    </div>
                
                <div class="post-intro-meta">
                    <!-- 撰写日期 -->
                    <span class="iconfont-archer post-intro-calander">&#xe676;</span>
                    <span class="post-intro-time">2021/10/15</span>
                    <!-- busuanzi -->
                    
                        <span id="busuanzi_container_page_pv" class="busuanzi-pv">
                            <span class="iconfont-archer post-intro-busuanzi">&#xe602;</span>
                            <span id="busuanzi_value_page_pv"></span>
                        </span>
                    
                    <!-- 文章分享 -->
                    <span class="share-wrapper">
                        <span class="iconfont-archer share-icon">&#xe71d;</span>
                        <span class="share-text">Share</span>
                        <ul class="share-list">
                            <li class="iconfont-archer share-qr" data-type="qr">&#xe75b;
                                <div class="share-qrcode"></div>
                            </li>
                            <li class="iconfont-archer" data-type="weibo">&#xe619;</li>
                            <li class="iconfont-archer" data-type="qzone">&#xe62e;</li>
                            <li class="iconfont-archer" data-type="twitter">&#xe634;</li>
                            <li class="iconfont-archer" data-type="facebook">&#xe67a;</li>
                        </ul>
                    </span>
                </div>
            </div>
        
    </div>
</div>

            <script>
  // get user agent
  function getBrowserVersions() {
    var u = window.navigator.userAgent
    return {
      userAgent: u,
      trident: u.indexOf('Trident') > -1, //IE内核
      presto: u.indexOf('Presto') > -1, //opera内核
      webKit: u.indexOf('AppleWebKit') > -1, //苹果、谷歌内核
      gecko: u.indexOf('Gecko') > -1 && u.indexOf('KHTML') == -1, //火狐内核
      mobile: !!u.match(/AppleWebKit.*Mobile.*/), //是否为移动终端
      ios: !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/), //ios终端
      android: u.indexOf('Android') > -1 || u.indexOf('Linux') > -1, //android终端或者uc浏览器
      iPhone: u.indexOf('iPhone') > -1 || u.indexOf('Mac') > -1, //是否为iPhone或者安卓QQ浏览器
      iPad: u.indexOf('iPad') > -1, //是否为iPad
      webApp: u.indexOf('Safari') == -1, //是否为web应用程序，没有头部与底部
      weixin: u.indexOf('MicroMessenger') == -1, //是否为微信浏览器
      uc: u.indexOf('UCBrowser') > -1, //是否为android下的UC浏览器
    }
  }
  var browser = {
    versions: getBrowserVersions(),
  }
  console.log('userAgent: ' + browser.versions.userAgent)

  // callback
  function fontLoaded() {
    console.log('font loaded')
    if (document.getElementsByClassName('site-intro-meta')) {
      document
        .getElementsByClassName('intro-title')[0]
        .classList.add('intro-fade-in')
      document
        .getElementsByClassName('intro-subtitle')[0]
        .classList.add('intro-fade-in')
      var postIntros = document.getElementsByClassName('post-intros')[0]
      if (postIntros) {
        postIntros.classList.add('post-fade-in')
      }
    }
  }

  // UC不支持跨域，所以直接显示
  function asyncCb() {
    if (browser.versions.uc) {
      console.log('UCBrowser')
      fontLoaded()
    } else {
      WebFont.load({
        custom: {
          families: ['Oswald-Regular'],
        },
        loading: function () {
          // 所有字体开始加载
          // console.log('font loading');
        },
        active: function () {
          // 所有字体已渲染
          fontLoaded()
        },
        inactive: function () {
          // 字体预加载失败，无效字体或浏览器不支持加载
          console.log('inactive: timeout')
          fontLoaded()
        },
        timeout: 5000, // Set the timeout to two seconds
      })
    }
  }

  function asyncErr() {
    console.warn('script load from CDN failed, will load local script')
  }

  // load webfont-loader async, and add callback function
  function async(u, cb, err) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0]
    o.src = u
    if (cb) {
      o.addEventListener(
        'load',
        function (e) {
          cb(null, e)
        },
        false
      )
    }
    if (err) {
      o.addEventListener(
        'error',
        function (e) {
          err(null, e)
        },
        false
      )
    }
    s.parentNode.insertBefore(o, s)
  }

  var asyncLoadWithFallBack = function (arr, success, reject) {
    var currReject = function () {
      reject()
      arr.shift()
      if (arr.length) async(arr[0], success, currReject)
    }

    async(arr[0], success, currReject)
  }

  asyncLoadWithFallBack(
    [
      'https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.min.js',
      'https://cdn.bootcss.com/webfont/1.6.28/webfontloader.js',
      "/lib/webfontloader.min.js",
    ],
    asyncCb,
    asyncErr
  )
</script>

            <img class="loading" src="/assets/loading.svg" style="display: block; margin: 6rem auto 0 auto; width: 6rem; height: 6rem;" />
            <div class="container container-unloaded">
                <main class="main post-page">
    <article class="article-entry">
        <h1 id="Flutter"><a href="#Flutter" class="headerlink" title="Flutter"></a>Flutter</h1><ul>
<li>1.开发效率高- 快发阶段 JIT 即时编译，支持 HotReload，节省开发时间.发布节点 AOT提前编译生成高效机器码保证应用性能</li>
<li>2.高性能-基于 Skia 引擎提供高保证的 UI 体验</li>
<li>3.快速内存分配-Flutter 框架使用函数式流，这使得它在很大程度上依赖于底层的内存分配器。</li>
<li>4.类型安全和空安全-2.12 后开始支持空安全和静态类型检测，在编译前提前发现错误，并排除潜在的问题。</li>
</ul>
<h2 id="Flutter-技术栈"><a href="#Flutter-技术栈" class="headerlink" title="Flutter 技术栈"></a>Flutter 技术栈</h2><p><img src="https://pic.imgdb.cn/item/627cb9bb0947543129c1aafa.jpg"></p>
<h2 id="Flutter的三棵树"><a href="#Flutter的三棵树" class="headerlink" title="Flutter的三棵树"></a>Flutter的三棵树</h2><p><img src="https://pic.imgdb.cn/item/627d2c35094754312966eee5.jpg"></p>
<h1 id="Flutter-核心原理"><a href="#Flutter-核心原理" class="headerlink" title="Flutter 核心原理"></a>Flutter 核心原理</h1><h2 id="JIT-即时编译与-AOT-提前编译"><a href="#JIT-即时编译与-AOT-提前编译" class="headerlink" title="JIT 即时编译与 AOT 提前编译"></a>JIT 即时编译与 AOT 提前编译</h2><p>Flutter 是一个跨平台的 UI 工具包，旨在允许代码在 iOS 和 Android 等操作系统之间重用，同时还允许应用程序直接与底层平台服务交互。目标是使开发人员能够交付在不同平台上感觉自然的高性能应用程序，在共享尽可能多的代码的同时接受它们存在的差异。</p>
<ul>
<li><strong>JIT</strong>: 在开发过程中，Flutter 应用程序在虚拟机中运行，该虚拟机提供有状态的热重载更改，而无需完全重新编译。</li>
<li><strong>AOT</strong>: 对于发布，Flutter 应用程序直接编译为机器代码，无论是 Intel x64 还是 ARM 指令，或者如果针对 Web，则编译为 JavaScript。</li>
</ul>
<h3 id="Flutter-Native架构"><a href="#Flutter-Native架构" class="headerlink" title="Flutter Native架构"></a>Flutter Native架构</h3><p>Flutter 被设计成一个可扩展的分层系统。它作为一系列独立的库存在，每个库都依赖于底层。任何层都没有特权访问下面的层，并且框架层的每个部分都被设计为可选和可替换的。</p>
<ul>
<li><strong>Framework框架层</strong><ul>
<li><strong>dart:ui层</strong>：包括 Foundation&#x2F;Animation&#x2F;Painting&#x2F;Gestures，这是Flutter engine暴露出来的底层 UI 库，提供了动画、手势和绘制的能力</li>
<li><strong>Rending渲染层</strong>，渲染层依赖 Dart UI层，负责渲染对象对应的渲染树，当动态更新 Widget 时，渲染树对比变化的部分，更新渲染。渲染层负责确定渲染对象的位置、大小和坐标变换和绘制</li>
<li><strong>Widget是基础组件库</strong>，提供了 Materia 和 Cupertino 两种视觉风格的组件库</li>
</ul>
</li>
<li><strong>Engine引擎层</strong><ul>
<li>引擎层包含 Skia 引擎、Dart 运行时。文字排版引擎。调用 dart:ui库最终调用的是引擎层之后进行绘制和显示</li>
</ul>
</li>
<li><strong>Embeded嵌入层</strong>负责将 Flutter 引擎嵌入到特定的系统中。嵌入层采用当前平台的语言编写.<ul>
<li>例如 Android 使用的是 Java 和 C++， iOS 和 macOS 使用的是 Objective-C 和 Objective-C++，Windows 和 Linux 使用的是 C++。 Flutter 代码可以通过嵌入层，以模块方式集成到现有的应用中，也可以作为应用的主体。Flutter 本身包含了各个常见平台的嵌入层，假如以后 Flutter 要支持新的平台，则需要针对该新的平台编写一个嵌入层。</li>
</ul>
</li>
</ul>
<p><img src="https://pic.imgdb.cn/item/627cbc1c0947543129c97cb8.jpg"></p>
<h3 id="Flutter-Web架构"><a href="#Flutter-Web架构" class="headerlink" title="Flutter Web架构"></a>Flutter Web架构</h3><p><img src="https://pic.imgdb.cn/item/627d0ee309475431290097c1.jpg"></p>
<h2 id="一、Flutter渲染和布局"><a href="#一、Flutter渲染和布局" class="headerlink" title="一、Flutter渲染和布局"></a>一、Flutter渲染和布局</h2><p>Flutter绕过系统 UI 部件库，转而使用自己的小部件集。绘制 Flutter 视觉效果的 Dart 代码被编译成原生代码，使用 Skia 进行渲染。Flutter 还嵌入了自己的 Skia 副本作为引擎的一部分，即使手机没有更新新的 Android 版本，开发人员也可以升级他们的应用程序以保持最新的性能改进。Flutter 在其他原生平台上也是如此，例如 iOS、Windows 或 macOS。</p>
<p><img src="https://pic.imgdb.cn/item/627da9cb094754312944ea83.jpg"></p>
<h3 id="从用户输入到-GPU"><a href="#从用户输入到-GPU" class="headerlink" title="从用户输入到 GPU"></a>从用户输入到 GPU</h3><p>Flutter 应用于其渲染管道的最重要原则是 <strong>简单即快速</strong>。Flutter 对数据如何流向系统有一个简单的管道，如下面的时序图所示：</p>
<p><img src="https://docs.flutter.dev/assets/images/docs/arch-overview/render-pipeline.png" alt="渲染管线时序图"></p>
<h3 id="布局和渲染"><a href="#布局和渲染" class="headerlink" title="布局和渲染"></a>布局和渲染</h3><p><img src="https://docs.flutter.dev/assets/images/docs/arch-overview/trees.png"><br>所有<code>RenderObject</code>s 的根是<code>RenderView</code>，它表示渲染树的总输出。当平台要求渲染新帧时（例如，由于 <a target="_blank" rel="noopener" href="https://source.android.com/devices/graphics/implement-vsync">vsync</a>或由于纹理解压缩&#x2F;上传完成)，将调用该 <code>compositeFrame()</code>方法，该方法是<code>RenderView</code>渲染树根部对象的一部分. 这将创建一个<code>SceneBuilder</code>来触发场景的更新。场景完成后，<code>RenderView</code>对象将合成的场景传递给 中的<code>Window.render()</code>方法<code>dart:ui</code>，该方法将控制权传递给 GPU 进行渲染。</p>
<p><img src="https://pic.imgdb.cn/item/627da96a0947543129441424.jpg"></p>
<h3 id="平台渠道"><a href="#平台渠道" class="headerlink" title="平台渠道"></a>平台渠道</h3><p>对于移动和桌面应用程序，Flutter 允许您通过_平台通道_调用自定义代码，这是一种用于在您的 Dart 代码和宿主应用程序的平台特定代码之间进行通信的机制。通过创建公共通道（封装名称和编解码器），您可以在 Dart 和使用 Kotlin 或 Swift 等语言编写的平台组件之间发送和接收消息。数据从 Dart 类型序列<code>Map</code>化为标准格式，然后反序列化为 Kotlin（如 <code>HashMap</code>）或 Swift（如<code>Dictionary</code>）中的等效表示。</p>
<p><img src="https://docs.flutter.dev/assets/images/docs/arch-overview/platform-channels.png" alt="平台通道如何让 Flutter 与宿主代码通信"></p>
<h3 id="Flutter三棵树与渲染流程"><a href="#Flutter三棵树与渲染流程" class="headerlink" title="Flutter三棵树与渲染流程"></a>Flutter三棵树与渲染流程</h3><h5 id="三棵树"><a href="#三棵树" class="headerlink" title="三棵树"></a>三棵树</h5><p><img src="https://docs.flutter.dev/assets/images/docs/arch-overview/trees.png"></p>
<ul>
<li>Widget树</li>
<li>Element 树 - <strong>Element创建相应的RenderObject并关联到Element.renderObject属性上</strong></li>
<li>RenderObject 树-<strong>RenderObject的主要职责是Layout和绘制，所有的RenderObject会组成一棵渲染树Render Tree。</strong><blockquote>
<p>我们重点看一下Element，根据Widget生成的Element创建相应的RenderObject并关联到Element.renderObject属性上，最后再通过RenderObject来完成布局排列和绘制。</p>
</blockquote>
</li>
</ul>
<h4 id="Element的生命周期如下："><a href="#Element的生命周期如下：" class="headerlink" title="Element的生命周期如下："></a>Element的生命周期如下：</h4><ol>
<li>Framework 调用Widget.createElement 创建一个Element实例，记为element</li>
<li>Framework 调用 element.mount(parentElement,newSlot) ，mount方法中首先调用element所对应Widget的createRenderObject方法创建与element相关联的RenderObject对象，然后调用element.attachRenderObject方法将element.renderObject添加到渲染树中插槽指定的位置（这一步不是必须的，一般发生在Element树结构发生变化时才需要重新attach）。插入到渲染树后的element就处于“active”状态，处于“active”状态后就可以显示在屏幕上了（可以隐藏）。</li>
<li>当有父Widget的配置数据改变时，同时其State.build返回的Widget结构与之前不同，此时就需要重新构建对应的Element树。为了进行Element复用，在Element重新构建前会先尝试是否可以复用旧树上相同位置的element，element节点在更新前都会调用其对应Widget的canUpdate方法，如果返回true，则复用旧Element，旧的Element会使用新Widget配置数据更新，反之则会创建一个新的Element。Widget.canUpdate主要是判断newWidget与oldWidget的runtimeType和key是否同时相等，如果同时相等就返回true，否则就会返回false。根据这个原理，当我们需要强制更新一个Widget时，可以通过指定不同的Key来避免复用。</li>
<li>当有祖先Element决定要移除element 时（如Widget树结构发生了变化，导致element对应的Widget被移除），这时该祖先Element就会调用deactivateChild 方法来移除它，移除后element.renderObject也会被从渲染树中移除，然后Framework会调用element.deactivate 方法，这时element状态变为“inactive”状态。</li>
<li>“inactive”态的element将不会再显示到屏幕。为了避免在一次动画执行过程中反复创建、移除某个特定element，“inactive”态的element在当前动画最后一帧结束前都会保留，如果在动画执行结束后它还未能重新变成“active”状态，Framework就会调用其unmount方法将其彻底移除，这时element的状态为defunct,它将永远不会再被插入到树中。</li>
<li>如果element要重新插入到Element树的其它位置，如element或element的祖先拥有一个GlobalKey（用于全局复用元素），那么Framework会先将element从现有位置移除，然后再调用其activate方法，并将其renderObject重新attach到渲染树。</li>
</ol>
<blockquote>
<p>RenderObject就是渲染树中的一个对象，它主要的作用是实现事件响应以及渲染管线中除过 build 的部分（build 部分由 element 实现），即包括：布局、绘制、层合成以及上屏，这些我们将在后面章节介绍。</p>
</blockquote>
<p>RenderObject拥有一个parent和一个parentData 属性，parent指向渲染树中自己的父节点，而parentData是一个预留变量，在父组件的布局过程，会确定其所有子组件布局信息（如位置信息，即相对于父组件的偏移），而这些布局信息需要在布局阶段保存起来，因为布局信息在后续的绘制阶段还需要被使用（用于确定组件的绘制位置），而parentData属性的主要作用就是保存布局信息，比如在 Stack 布局中，RenderStack就会将子元素的偏移数据存储在子元素的parentData中（具体可以查看Positioned实现）。</p>
<p>RenderObject类本身实现了一套基础的布局和绘制协议，但是并没有定义子节点模型（如一个节点可以有几个子节点，没有子节点？一个？两个？或者更多？）。 它也没有定义坐标系统（如子节点定位是在笛卡尔坐标中还是极坐标？）和具体的布局协议（是通过宽高还是通过constraint和size?，或者是否由父节点在子节点布局之前或之后设置子节点的大小和位置等）。</p>
<p>为此，Flutter框架提供了一个RenderBox和一个 RenderSliver类，它们都是继承自RenderObject，布局坐标系统采用笛卡尔坐标系，屏幕的(top, left)是原点。而 Flutter 基于这两个类分别实现了基于 RenderBox 的盒模型布局和基于 Sliver 的按需加载模型，这个我们已经在前面章节介绍过</p>
<h4 id="1-BuildContext是什么？有什么作用？"><a href="#1-BuildContext是什么？有什么作用？" class="headerlink" title="1.BuildContext是什么？有什么作用？"></a>1.BuildContext是什么？有什么作用？</h4><blockquote>
<p>&#x2F;&#x2F;&#x2F; [BuildContext] objects are actually [Element] objects. The [BuildContext]<br>&#x2F;&#x2F;&#x2F; interface is used to discourage direct manipulation of [Element] objects.</p>
</blockquote>
<p><code>BuildContext</code> 是 Element对象，设计BuildContext的目的是避免我们直接操作<code>Element</code>对象。</p>
<p>BuildContext 就是我们 Widget 对应的 Element 对象，我们通过context 在 <code>StatelessWidget</code> 和 <code>StatefulWidget</code> 中的 build 方法直接访问到 Element 对象。</p>
<h4 id="2-setState-作用是什么？"><a href="#2-setState-作用是什么？" class="headerlink" title="2. setState 作用是什么？"></a>2. setState 作用是什么？</h4><blockquote>
<p>Notify the framework that the internal state of this object has changed.<br>Calling [setState] notifies the framework that the internal state of this object has changed in a way that might impact the user interface in this subtree, which causes the framework to schedule a [build] for this [State] object.</p>
</blockquote>
<p>通知dart 系统其内部对象的状态已经改变需要刷新<br>当widget发生改变时，在<code>setState调用markNeedsBuild()</code>方法将当前Element标记为dirty即可，标记为dirty的Element会在下一帧中重建。<strong>实际上，State.setState()在内部也是调用的markNeedsBuild()方法。</strong></p>
<h4 id="3-flutter如何原生通信？"><a href="#3-flutter如何原生通信？" class="headerlink" title="3 flutter如何原生通信？"></a>3 flutter如何原生通信？</h4><p>我们知道一个完整的Flutter应用程序实际上包括原生代码和Flutter代码两部分。<br>Flutter 中提供了平台通道（platform channel）用于Flutter和原生平台的通信，平台通道正是Flutter和原生之间通信的桥梁，它也是Flutter插件的底层基础设施。<br><strong>Flutter与原生之间的通信本质上是一个远程调用（RPC），通过消息传递实现：</strong></p>
<ul>
<li>应用的Flutter部分通过平台通道（platform channel）将调用消息发送到宿主应用。</li>
<li>宿主监听平台通道，并接收该消息。然后它会调用该平台的API，并将响应发送回Flutter。</li>
</ul>
<h2 id="二-、Flutter启动流程"><a href="#二-、Flutter启动流程" class="headerlink" title="二 、Flutter启动流程"></a>二 、Flutter启动流程</h2><h3 id="Flutter-App启动的三个步骤："><a href="#Flutter-App启动的三个步骤：" class="headerlink" title="Flutter App启动的三个步骤："></a>Flutter App启动的三个步骤：</h3><ul>
<li><p>1  main()-&gt;runApp()-&gt;<code>WidgetsFlutterBinding</code> 初始化（<code>ensureInitialized()</code>）,与 <code>Flutter Engine</code> 进行通信。</p>
</li>
<li><p>2 绑定根节点创建flutter 著名的三棵树（<code>scheduleAttachRootWidget(app)</code>）进行布局。</p>
</li>
<li><p>3 将布局出来的树进行渲染（<code>scheduleWarmUpFrame()</code>）</p>
</li>
</ul>
<blockquote>
<p> WidgetsFlutterBinding 将是 Widget 架构和 Flutter Engine 连接的核心桥梁，也是整个 Flutter 应用层的核心。通过 <code>ensureInitialized()</code> 方法我们可以得到一个全局单例 WidgetsFlutterBinding。</p>
</blockquote>
<p>Flutter的入口在”lib&#x2F;main.dart”的<code>main()</code>函数中，它是Dart应用程序的起点。在Flutter应用中，<code>main()</code>函数最简单的实现如下：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main() =&gt; runApp(MyApp());</span><br></pre></td></tr></table></figure>

<p>可以看<code>main()</code>函数只调用了一个<code>runApp()</code>方法，我们看看<code>runApp()</code>方法中都做了什么：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> runApp(Widget app) &#123;</span><br><span class="line">  WidgetsFlutterBinding.ensureInitialized()</span><br><span class="line">    ..attachRootWidget(app)</span><br><span class="line">    ..scheduleWarmUpFrame();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参数<code>app</code>是一个 widget，它是 Flutter 应用启动后要展示的第一个组件。</p>
<p><strong><code>WidgetsFlutterBinding</code>正是绑定Framework 框架和Flutter 引擎的桥梁</strong>，定义如下：</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h1h4uc76gmj22e90u0n6q.jpg"></p>
<p>我们打印下执行顺序，如下图示：</p>
<p><img src="http://img.cdn.guoshuyu.cn/20190604_Flutter-5/image3" alt="img"></p>
<p>通过查看这些 Binding的源码，我们可以<strong>发现WidgetsFlutterBinding通过这些Binding中来监听并处理<code>Window</code>对象的一些事件，然后将这些事件按照Framework的模型包装、抽象然后分发。可以看到<code>WidgetsFlutterBinding</code>正是粘连Flutter engine与上层Framework的“胶水”。</strong></p>
<ul>
<li><code>GestureBinding</code>：提供了<code>window.onPointerDataPacket</code> 回调，绑定Framework手势子系统，是Framework事件模型与底层事件的绑定入口。</li>
<li><code>ServicesBinding</code>：提供了<code>window.onPlatformMessage</code> 回调， 用于绑定平台消息通道（message channel），主要处理原生和Flutter通信。</li>
<li><code>SchedulerBinding</code>：提供了<code>window.onBeginFrame</code>和<code>window.onDrawFrame</code>回调，监听刷新事件，绑定Framework绘制调度子系统。</li>
<li><code>PaintingBinding</code>：绑定绘制库，主要用于处理图片缓存。</li>
<li><code>SemanticsBinding</code>：语义化层与Flutter engine的桥梁，主要是辅助功能的底层支持。</li>
<li><code>RendererBinding</code>: 提供了<code>window.onMetricsChanged</code> 、<code>window.onTextScaleFactorChanged</code> 等回调。它是渲染树与Flutter engine的桥梁。</li>
<li><code>WidgetsBinding</code>：提供了<code>window.onLocaleChanged</code>、<code>onBuildScheduled</code> 等回调。它是Flutter widget层与engine的桥梁。</li>
</ul>
<h3 id="WidgetsFlutterBinding作用"><a href="#WidgetsFlutterBinding作用" class="headerlink" title="WidgetsFlutterBinding作用"></a>WidgetsFlutterBinding作用</h3><p><strong><code>WidgetsFlutterBinding.ensureInitialized()</code>负责初始化一个<code>WidgetsBinding</code>的全局单例，紧接着会调用<code>WidgetsBinding</code>的<code>attachRootWidget</code>方法，该方法负责将根Widget添加到<code>RenderView</code>上</strong>，代码如下：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> attachRootWidget(Widget rootWidget) &#123;</span><br><span class="line">  _renderViewElement = RenderObjectToWidgetAdapter&lt;RenderBox&gt;(</span><br><span class="line">    container: renderView, </span><br><span class="line">    debugShortDescription: <span class="string">&#x27;[root]&#x27;</span>,</span><br><span class="line">    child: rootWidget</span><br><span class="line">  ).attachToRenderTree(buildOwner, renderViewElement);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>注意，代码中的有<code>renderView</code>和<code>renderViewElement</code>两个变量，**<code>renderView</code>是一个<code>RenderObject</code>，它是渲染树的根，而<code>renderViewElement</code>是<code>renderView</code>对应的<code>Element</code>对象，可见该方法主要完成了根widget到根 <code>RenderObject</code>再到根<code>Element</code>的整个关联过程。**</p>
<p><strong>组件树在构建（build）完毕后，回到runApp的实现中，当调用完attachRootWidget后，最后一行会调用 WidgetsFlutterBinding 实例的 scheduleWarmUpFrame() 方法，该方法的实现在SchedulerBinding 中，它被调用后会立即进行一次绘制，在此次绘制结束前，该方法会锁定事件分发，也就是说在本次绘制结束完成之前 Flutter 将不会响应各种事件，这可以保证在绘制过程中不会再触发新的重绘。</strong></p>
<h2 id="三、Flutter列表优化"><a href="#三、Flutter列表优化" class="headerlink" title="三、Flutter列表优化"></a>三、Flutter列表优化</h2><p>关键词：	<code>WidgetsFlutterBinding</code>、<code>handleBeginFrame</code>、<code>handleDrawFrame</code></p>
<h3 id="优化方式"><a href="#优化方式" class="headerlink" title="优化方式"></a>优化方式</h3><ul>
<li>局部刷新</li>
<li>高度使用<code>CacheExtends</code>缓存</li>
<li>推荐使用 <code>Selector </code>和 <code>Consumer</code> 避免不必要的 diff 计算和布局计算</li>
<li>减少使用<code>saveLayer</code>&#x2F;使用图片替换半透明效果以减轻 Raster 线程的开销</li>
<li><code>DSL 解析放到 isolate 中</code>将最大限度降低开销</li>
</ul>
<h4 id="列表空间滑动帧渲染流程"><a href="#列表空间滑动帧渲染流程" class="headerlink" title="列表空间滑动帧渲染流程"></a>列表空间滑动帧渲染流程</h4><p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h1h4bsmck7j20u00v5ads.jpg"></p>
<h4 id="局部刷新"><a href="#局部刷新" class="headerlink" title="局部刷新"></a>局部刷新</h4><h5 id="UI-层"><a href="#UI-层" class="headerlink" title="UI 层"></a>UI 层</h5><ul>
<li>setState 刷新最小化原则</li>
<li>高度已知的情况下使用 itemExtent</li>
<li>使用 Selector 或者 Consumer 来获取祖先 model</li>
<li>避免动画中裁剪图像，创建 Widget</li>
</ul>
<h5 id="GPU"><a href="#GPU" class="headerlink" title="GPU"></a>GPU</h5><ul>
<li>使用 RepaintBoundary 隔离频繁刷新视图</li>
<li>减少 saveLayer、clipRect、clipRRect 的使用</li>
<li>使用 AnimatedOpacity 后者 FadeInImage 替换 OpacityWidget</li>
<li>使用图片替换半透明效果</li>
<li>避免使用带有换行符的长文本</li>
</ul>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24ely1h1h55cqqbej211y0g00uu.jpg"></p>
<h4 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h4><ul>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/6FLMcE67BCbXvnbFSRgHFg">阿里-构建顺滑自然的 Flutter 页面</a></li>
<li><a target="_blank" rel="noopener" href="https://book.flutterchina.club/chapter14/flutter_app_startup.html#_14-3-1-%E5%90%AF%E5%8A%A8">Flutter 实战-启动流程和渲染管线</a></li>
<li><a target="_blank" rel="noopener" href="https://book.flutterchina.club/chapter14/">Flutter 核心原理</a><ul>
<li><a target="_blank" rel="noopener" href="https://book.flutterchina.club/chapter14/flutter_ui_system.html">14.1：Flutter UI框架（Framework）</a></li>
<li><a target="_blank" rel="noopener" href="https://book.flutterchina.club/chapter14/element_buildcontext.html">14.2：Element、BuildContext和RenderObject</a></li>
<li><a target="_blank" rel="noopener" href="https://book.flutterchina.club/chapter14/flutter_app_startup.html">14.3：Flutter启动流程和渲染管线</a></li>
<li><a target="_blank" rel="noopener" href="https://book.flutterchina.club/chapter14/layout.html">14.4：Flutter 布局（Layout）过程</a></li>
<li><a target="_blank" rel="noopener" href="https://book.flutterchina.club/chapter14/paint.html">14.5：Flutter 绘制（一）绘制原理及Layer</a></li>
<li><a target="_blank" rel="noopener" href="https://book.flutterchina.club/chapter14/paint.html">14.6：Flutter 绘制（二）组件树绘制流程</a></li>
<li><a target="_blank" rel="noopener" href="https://book.flutterchina.club/chapter14/layer.html">14.7：Flutter 绘制（三）Layer实例</a></li>
<li><a target="_blank" rel="noopener" href="https://book.flutterchina.club/chapter14/compositing.html">14.8：Flutter 绘制（四）Compositing</a></li>
</ul>
</li>
</ul>

    </article>
    <!-- license -->
    
        <div class="license-wrapper">
            <p>原文作者：<a href="https://mingriweiji-github.github.io">KM</a>
            <p>原文链接：<a href="https://mingriweiji-github.github.io/2021/10/15/Flutter%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/">https://mingriweiji-github.github.io/2021/10/15/Flutter%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/</a>
            <p>发表日期：<a href="https://mingriweiji-github.github.io/2021/10/15/Flutter%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/">十月 15日 2021, 10:15:10 上午</a>
            <p>更新日期：<a href="https://mingriweiji-github.github.io/2021/10/15/Flutter%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/">五月 13日 2022, 8:27:20 晚上</a>
            <p>版权声明：本文采用<a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc/4.0/">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可</p>
        </div>
    
    <!-- paginator -->
    <ul class="post-paginator">
        <li class="next">
            
                <div class="nextSlogan">Next Post</div>
                <a href="/2022/01/10/%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E4%BB%A3%E7%A0%81%E8%AF%84%E5%AE%A1/" title="如何进行代码评审">
                    <div class="nextTitle">如何进行代码评审</div>
                </a>
            
        </li>
        <li class="previous">
            
                <div class="prevSlogan">Previous Post</div>
                <a href="/2021/09/20/Flutter%20%E5%AE%9E%E6%88%98%E8%AE%B0%E5%BD%95/" title="Flutter 实战记录">
                    <div class="prevTitle">Flutter 实战记录</div>
                </a>
            
        </li>
    </ul>
    <!-- comment -->
    
        <div class="post-comment">
            <!-- 来必力 City 版安装代码 -->


            

            

            

            <!-- utteranc评论 -->


            <!-- partial('_partial/comment/changyan') -->
            <!--PC版-->


            
            

            

        </div>
    
    <!-- timeliness note -->
    <!-- idea from: https://hexo.fluid-dev.com/posts/hexo-injector/#%E6%96%87%E7%AB%A0%E6%97%B6%E6%95%88%E6%80%A7%E6%8F%90%E7%A4%BA -->
    
    <!-- Mathjax -->
    
        

    
</main>

                <!-- profile -->
                
            </div>
            <footer class="footer footer-unloaded">
    <!-- social  -->
    
        <div class="social">
            
    
        
    
        
            
                <a href="https://github.com/Mingriweiji-github" class="iconfont-archer github" target="_blank" title=github></a>
            
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    


        </div>
    
    <!-- powered by Hexo  -->
    <div class="copyright">
        <span id="hexo-power">Powered by <a href="https://hexo.io/" target="_blank">Hexo</a></span><span class="iconfont-archer power">&#xe635;</span><span id="theme-info">theme <a href="https://github.com/fi3ework/hexo-theme-archer" target="_blank">Archer</a></span>
    </div>
    <!-- website approve for Chinese user -->
    
    <!-- 不蒜子  -->
    
        <div class="busuanzi-container">
            
             
                <span id="busuanzi_container_site_pv">PV: <span id="busuanzi_value_site_pv"></span> :)</span>
            
        </div>
    	
</footer>

        </div>
        <!-- toc -->
        
            <div class="toc-wrapper toc-wrapper-loding" style=







    top:50vh;

>
                <div class="toc-catalog">
                    <span class="iconfont-archer catalog-icon">&#xe613;</span><span>CATALOG</span>
                </div>
                <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Flutter"><span class="toc-number">1.</span> <span class="toc-text">Flutter</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Flutter-%E6%8A%80%E6%9C%AF%E6%A0%88"><span class="toc-number">1.1.</span> <span class="toc-text">Flutter 技术栈</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Flutter%E7%9A%84%E4%B8%89%E6%A3%B5%E6%A0%91"><span class="toc-number">1.2.</span> <span class="toc-text">Flutter的三棵树</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Flutter-%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86"><span class="toc-number">2.</span> <span class="toc-text">Flutter 核心原理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#JIT-%E5%8D%B3%E6%97%B6%E7%BC%96%E8%AF%91%E4%B8%8E-AOT-%E6%8F%90%E5%89%8D%E7%BC%96%E8%AF%91"><span class="toc-number">2.1.</span> <span class="toc-text">JIT 即时编译与 AOT 提前编译</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Flutter-Native%E6%9E%B6%E6%9E%84"><span class="toc-number">2.1.1.</span> <span class="toc-text">Flutter Native架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flutter-Web%E6%9E%B6%E6%9E%84"><span class="toc-number">2.1.2.</span> <span class="toc-text">Flutter Web架构</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81Flutter%E6%B8%B2%E6%9F%93%E5%92%8C%E5%B8%83%E5%B1%80"><span class="toc-number">2.2.</span> <span class="toc-text">一、Flutter渲染和布局</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8E%E7%94%A8%E6%88%B7%E8%BE%93%E5%85%A5%E5%88%B0-GPU"><span class="toc-number">2.2.1.</span> <span class="toc-text">从用户输入到 GPU</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%83%E5%B1%80%E5%92%8C%E6%B8%B2%E6%9F%93"><span class="toc-number">2.2.2.</span> <span class="toc-text">布局和渲染</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B9%B3%E5%8F%B0%E6%B8%A0%E9%81%93"><span class="toc-number">2.2.3.</span> <span class="toc-text">平台渠道</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Flutter%E4%B8%89%E6%A3%B5%E6%A0%91%E4%B8%8E%E6%B8%B2%E6%9F%93%E6%B5%81%E7%A8%8B"><span class="toc-number">2.2.4.</span> <span class="toc-text">Flutter三棵树与渲染流程</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%89%E6%A3%B5%E6%A0%91"><span class="toc-number">2.2.4.0.1.</span> <span class="toc-text">三棵树</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Element%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%A6%82%E4%B8%8B%EF%BC%9A"><span class="toc-number">2.2.4.1.</span> <span class="toc-text">Element的生命周期如下：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-BuildContext%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F%E6%9C%89%E4%BB%80%E4%B9%88%E4%BD%9C%E7%94%A8%EF%BC%9F"><span class="toc-number">2.2.4.2.</span> <span class="toc-text">1.BuildContext是什么？有什么作用？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-setState-%E4%BD%9C%E7%94%A8%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">2.2.4.3.</span> <span class="toc-text">2. setState 作用是什么？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-flutter%E5%A6%82%E4%BD%95%E5%8E%9F%E7%94%9F%E9%80%9A%E4%BF%A1%EF%BC%9F"><span class="toc-number">2.2.4.4.</span> <span class="toc-text">3 flutter如何原生通信？</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-%E3%80%81Flutter%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B"><span class="toc-number">2.3.</span> <span class="toc-text">二 、Flutter启动流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Flutter-App%E5%90%AF%E5%8A%A8%E7%9A%84%E4%B8%89%E4%B8%AA%E6%AD%A5%E9%AA%A4%EF%BC%9A"><span class="toc-number">2.3.1.</span> <span class="toc-text">Flutter App启动的三个步骤：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WidgetsFlutterBinding%E4%BD%9C%E7%94%A8"><span class="toc-number">2.3.2.</span> <span class="toc-text">WidgetsFlutterBinding作用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81Flutter%E5%88%97%E8%A1%A8%E4%BC%98%E5%8C%96"><span class="toc-number">2.4.</span> <span class="toc-text">三、Flutter列表优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E6%96%B9%E5%BC%8F"><span class="toc-number">2.4.1.</span> <span class="toc-text">优化方式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%97%E8%A1%A8%E7%A9%BA%E9%97%B4%E6%BB%91%E5%8A%A8%E5%B8%A7%E6%B8%B2%E6%9F%93%E6%B5%81%E7%A8%8B"><span class="toc-number">2.4.1.1.</span> <span class="toc-text">列表空间滑动帧渲染流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B1%80%E9%83%A8%E5%88%B7%E6%96%B0"><span class="toc-number">2.4.1.2.</span> <span class="toc-text">局部刷新</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#UI-%E5%B1%82"><span class="toc-number">2.4.1.2.1.</span> <span class="toc-text">UI 层</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#GPU"><span class="toc-number">2.4.1.2.2.</span> <span class="toc-text">GPU</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E8%80%83%EF%BC%9A"><span class="toc-number">2.4.1.3.</span> <span class="toc-text">参考：</span></a></li></ol></li></ol></li></ol></li></ol>
            </div>
        
        <!-- sidebar -->
        <div class="sidebar sidebar-hide">
    <ul class="sidebar-tabs sidebar-tabs-active-0">
        <li class="sidebar-tab-archives"><span class="iconfont-archer">&#xe67d;</span><span class="tab-name">Archive</span></li>
        <li class="sidebar-tab-tags"><span class="iconfont-archer">&#xe61b;</span><span class="tab-name">Tag</span></li>
        <li class="sidebar-tab-categories"><span class="iconfont-archer">&#xe666;</span><span class="tab-name">Cate</span></li>
    </ul>
    <div class="sidebar-content sidebar-content-show-archive">
        <div class="sidebar-panel-archives">
    <!-- 在 ejs 中将 archive 按照时间排序 -->
    
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
    
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
    
    
    
    
    <div class="total-and-search">
        <div class="total-archive">
        Total : 33
        </div>
        <!-- search  -->
        
    </div>
    
    <div class="post-archive">
    
        
            
            
            <div class="archive-year"> 2022 </div>
            <ul class="year-list">
            
        
        <li class="archive-post-item">
            <span class="archive-post-date">05/12</span>
            <a class="archive-post-title" href="/2022/05/12/Flutter%E6%AD%A3%E5%BC%8F%E5%8F%91%E5%B8%833.0/">Flutter正式发布3.0</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">03/10</span>
            <a class="archive-post-title" href="/2022/03/10/%E8%B0%B7%E6%AD%8C%E7%9A%84%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B/">谷歌的软件工程</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">01/10</span>
            <a class="archive-post-title" href="/2022/01/10/%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E4%BB%A3%E7%A0%81%E8%AF%84%E5%AE%A1/">如何进行代码评审</a>
        </li>
    
        
            
            
                
                </ul>
            
            <div class="archive-year"> 2021 </div>
            <ul class="year-list">
            
        
        <li class="archive-post-item">
            <span class="archive-post-date">10/15</span>
            <a class="archive-post-title" href="/2021/10/15/Flutter%20%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/">Flutter 核心原理</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">09/20</span>
            <a class="archive-post-title" href="/2021/09/20/Flutter%20%E5%AE%9E%E6%88%98%E8%AE%B0%E5%BD%95/">Flutter 实战记录</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">06/15</span>
            <a class="archive-post-title" href="/2021/06/15/Flutter%20%E8%B5%84%E6%BA%90/">Flutter 资源</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">03/15</span>
            <a class="archive-post-title" href="/2021/03/15/Flutter%20Widget/">Flutter Widget</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">01/15</span>
            <a class="archive-post-title" href="/2021/01/15/Flutter%20Dart%E5%9F%BA%E7%A1%80/">Flutter Dar基础</a>
        </li>
    
        
            
            
                
                </ul>
            
            <div class="archive-year"> 2020 </div>
            <ul class="year-list">
            
        
        <li class="archive-post-item">
            <span class="archive-post-date">06/30</span>
            <a class="archive-post-title" href="/2020/06/30/URLProtocol%E6%BA%90%E7%A0%81/">URLProtocol源码</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">06/30</span>
            <a class="archive-post-title" href="/2020/06/30/Alamfire%E6%BA%90%E7%A0%81/">Alamfire源码</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">06/30</span>
            <a class="archive-post-title" href="/2020/06/30/Kingfisher%E6%BA%90%E7%A0%81/">Kingfisher源码</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">06/25</span>
            <a class="archive-post-title" href="/2020/06/25/Swift%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80%E5%88%9D%E6%8E%A2/">Swift内存布局初探</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">06/20</span>
            <a class="archive-post-title" href="/2020/06/20/Swift%E5%AD%97%E7%AC%A6%E4%B8%B2/">Swift字符串</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">04/18</span>
            <a class="archive-post-title" href="/2020/04/18/Swift%E6%A0%87%E5%87%86%E5%BA%93%E6%BA%90%E7%A0%81/">Swift标准库源码</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">04/18</span>
            <a class="archive-post-title" href="/2020/04/18/Swift%E9%9B%86%E5%90%88%E6%BA%90%E7%A0%81/">Swift集合源码</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">02/20</span>
            <a class="archive-post-title" href="/2020/02/20/Swift%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B/">Swift函数式编程</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">01/20</span>
            <a class="archive-post-title" href="/2020/01/20/LookinLoader%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/">LookinLoader安装使用</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">01/15</span>
            <a class="archive-post-title" href="/2020/01/15/Dyld%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/">Dyld源码阅读</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">01/15</span>
            <a class="archive-post-title" href="/2020/01/15/iOS%E8%B6%8A%E7%8B%B1%E5%88%9D%E4%BD%93%E9%AA%8C/">iOS越狱初体验</a>
        </li>
    
        
            
            
                
                </ul>
            
            <div class="archive-year"> 2019 </div>
            <ul class="year-list">
            
        
        <li class="archive-post-item">
            <span class="archive-post-date">06/22</span>
            <a class="archive-post-title" href="/2019/06/22/2020%E7%AE%97%E6%B3%95%E5%AE%9E%E6%88%98100%E9%81%93/">算法实战</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">06/22</span>
            <a class="archive-post-title" href="/2019/06/22/2020%E7%AE%97%E6%B3%95%E5%9F%BA%E7%A1%80/">算法基础</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">06/22</span>
            <a class="archive-post-title" href="/2019/06/22/2020%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">数据结构思想</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">06/08</span>
            <a class="archive-post-title" href="/2019/06/08/%E7%BA%A2%E9%BB%91%E6%A0%91%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F/">红黑树前世今生</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">06/06</span>
            <a class="archive-post-title" href="/2019/06/06/%E4%BA%8C%E5%8F%89%E6%A0%91%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F/">二叉树今生</a>
        </li>
    
        
            
            
                
                </ul>
            
            <div class="archive-year"> 2018 </div>
            <ul class="year-list">
            
        
        <li class="archive-post-item">
            <span class="archive-post-date">12/02</span>
            <a class="archive-post-title" href="/2018/12/02/iOS%E6%B1%87%E7%BC%96%E5%9F%BA%E7%A1%80/">iOS汇编基础</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">12/01</span>
            <a class="archive-post-title" href="/2018/12/01/iOS%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/">iOS图像优化技巧</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">06/02</span>
            <a class="archive-post-title" href="/2018/06/02/Hexo%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/">Hexo使用指南</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">06/01</span>
            <a class="archive-post-title" href="/2018/06/01/iOS%E5%A4%9A%E7%BA%BF%E7%A8%8B/">iOS多线程</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">06/01</span>
            <a class="archive-post-title" href="/2018/06/01/Runloop/">Runloop</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">02/18</span>
            <a class="archive-post-title" href="/2018/02/18/Swift%E5%A4%87%E5%BF%98%E5%BD%95/">Swift备忘录</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span>
            <a class="archive-post-title" href="/2018/01/01/%E6%8E%92%E5%BA%8F%E9%97%AE%E9%A2%98/">排序问题</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span>
            <a class="archive-post-title" href="/2018/01/01/%E5%8F%8D%E8%BD%AC%E9%97%AE%E9%A2%98/">反转问题</a>
        </li>
    
        
        <li class="archive-post-item">
            <span class="archive-post-date">01/01</span>
            <a class="archive-post-title" href="/2018/01/01/%E8%80%81%E9%BC%A0%E6%AF%92%E8%8D%AF%E9%97%AE%E9%A2%98/">老鼠毒药问题</a>
        </li>
    
    </div>
</div>

        <div class="sidebar-panel-tags">
    <div class="sidebar-tags-name">
        
            <span class="sidebar-tag-name" data-tags="java">
                <span class="iconfont-archer">&#xe606;</span>
                java
            </span>
        
            <span class="sidebar-tag-name" data-tags="算法">
                <span class="iconfont-archer">&#xe606;</span>
                算法
            </span>
        
            <span class="sidebar-tag-name" data-tags="Swift专题">
                <span class="iconfont-archer">&#xe606;</span>
                Swift专题
            </span>
        
            <span class="sidebar-tag-name" data-tags="iOS">
                <span class="iconfont-archer">&#xe606;</span>
                iOS
            </span>
        
            <span class="sidebar-tag-name" data-tags="Flutter">
                <span class="iconfont-archer">&#xe606;</span>
                Flutter
            </span>
        
            <span class="sidebar-tag-name" data-tags="开发工具">
                <span class="iconfont-archer">&#xe606;</span>
                开发工具
            </span>
        
            <span class="sidebar-tag-name" data-tags="book">
                <span class="iconfont-archer">&#xe606;</span>
                book
            </span>
        
    </div>
    <div class="iconfont-archer sidebar-tags-empty">&#xe678;</div>
    <div class="tag-load-fail" style="display: none; color: #ccc; font-size: 0.6rem;">
        缺失模块，请参考主题文档进行安装配置：https://github.com/fi3ework/hexo-theme-archer#%E5%AE%89%E8%A3%85%E4%B8%BB%E9%A2%98
    </div> 
    <div class="sidebar-tags-list"></div>
</div>

        <div class="sidebar-panel-categories">
    <div class="sidebar-categories-name">
    
        <span class="sidebar-category-name" data-categories="算法">
            <span class="iconfont-archer">&#xe60a;</span>
            算法
        </span>
    
        <span class="sidebar-category-name" data-categories="源码">
            <span class="iconfont-archer">&#xe60a;</span>
            源码
        </span>
    
        <span class="sidebar-category-name" data-categories="Flutter">
            <span class="iconfont-archer">&#xe60a;</span>
            Flutter
        </span>
    
        <span class="sidebar-category-name" data-categories="指南">
            <span class="iconfont-archer">&#xe60a;</span>
            指南
        </span>
    
        <span class="sidebar-category-name" data-categories="Swift">
            <span class="iconfont-archer">&#xe60a;</span>
            Swift
        </span>
    
        <span class="sidebar-category-name" data-categories="图像">
            <span class="iconfont-archer">&#xe60a;</span>
            图像
        </span>
    
        <span class="sidebar-category-name" data-categories="逆向">
            <span class="iconfont-archer">&#xe60a;</span>
            逆向
        </span>
    
        <span class="sidebar-category-name" data-categories="book">
            <span class="iconfont-archer">&#xe60a;</span>
            book
        </span>
    
    </div>
    <div class="iconfont-archer sidebar-categories-empty">&#xe678;</div>
    <div class="sidebar-categories-list"></div>
</div>

    </div>
</div>

        <!-- site-meta -->
        <script>
    var siteMetaRoot = "/"
    if (siteMetaRoot === "undefined") {
        siteMetaRoot = '/'
    }
    var siteMeta = {
        url: "https://mingriweiji-github.github.io",
        root: siteMetaRoot,
        author: "KM"
    }
</script>

        <!-- import experimental options here -->
        <!-- Custom Font -->


        <!-- main func -->
        <script src="/scripts/main.js?v=20211217"></script>
        <!-- dark mode -->
        <script src="/scripts/dark.js?v=20211217"></script>
        <!-- fancybox -->
        <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" defer></script>
        <!-- algolia -->
        
        <!-- busuanzi -->
        
            <script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>
        
        <!-- CNZZ -->
        
        <!-- async load share.js -->
        
            <script src="/scripts/share.js?v=20211217" async></script>
        
        <!-- mermaid -->
        
    </body>
</html>
